<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{fragments/client/head :: head}"></th:block>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">

    <style>
        /* [GI·ªÆ NGUY√äN CSS C·ª¶A BRO - KH√îNG THAY ƒê·ªîI M√ÄU N·ªÄN] */

        /* 1. BANNER */
        .main-banner-item {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .main-banner-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* DOTS BANNER */
        .owl-theme .owl-dots .owl-dot span {
            width: 12px;
            height: 12px;
            margin: 5px 7px;
            background: rgba(255, 255, 255, 0.5);
        }

        .owl-theme .owl-dots .owl-dot.active span {
            background: #0d6efd;
            transform: scale(1.2);
        }

        /* 2. CARD S·∫¢N PH·∫®M */
        .card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: transparent;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3) !important;
            border-color: #0d6efd;
            transform: translateY(-5px);
        }

        /* KHUNG ·∫¢NH CƒÇN GI·ªÆA (ƒê√£ cƒÉn ch·ªânh) */
        .card-img-container {
            width: 100%;
            height: 230px;
            display: flex; /* D√πng Flexbox ƒë·ªÉ cƒÉn gi·ªØa */
            align-items: center; /* CƒÉn gi·ªØa d·ªçc */
            justify-content: center; /* CƒÉn gi·ªØa ngang */
            background-color: #fff;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            position: relative;
        }

        .card-img-container a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .card-img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* ·∫¢nh gi·ªØ t·ª∑ l·ªá, kh√¥ng b·ªã m√©o */
            transition: transform 0.4s ease;
        }

        .card:hover .card-img-container img {
            transform: scale(1.08);
        }

        /* BADGES */
        .badge-discount {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.8rem;
            z-index: 10;
        }

        .badge-coming-soon {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .badge-category {
            background-color: #0d6efd;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .price-old {
            color: #adb5bd !important;
            opacity: 0.7;
            font-size: 0.9rem;
            text-decoration: line-through;
            margin-left: 8px;
        }
    </style>
</head>

<body>

<nav th:replace="~{fragments/client/header :: header}"></nav>

<main class="flex-grow-1 bg-body-tertiary">

    <section class="container mt-4 mb-5">
        <div class="owl-carousel owl-theme" id="nvkBannerSlider">
            <div class="item">
                <div class="main-banner-item"><img
                        src="https://placehold.co/1200x400/111/fff?text=SIEU+SALE+IPHONE+15+PRO+MAX&font=roboto"
                        alt="Banner 1"></div>
            </div>
            <div class="item">
                <div class="main-banner-item"><img
                        src="https://placehold.co/1200x400/0d6efd/fff?text=LAPTOP+GAMING+GIAM+SOC+20%25&font=roboto"
                        alt="Banner 2"></div>
            </div>
            <div class="item">
                <div class="main-banner-item"><img
                        src="https://placehold.co/1200x400/ffc107/000?text=PHU+KIEN+CHINH+HANG+-+MUA+1+TANG+1&font=roboto"
                        alt="Banner 3"></div>
            </div>
        </div>
    </section>

    <section class="container my-5">
        <h3 class="mb-4 text-white border-start border-4 border-warning ps-3">üî• C√≥ th·ªÉ b·∫°n quan t√¢m</h3>

        <div th:if="${listRandom == null || listRandom.isEmpty()}" class="text-white opacity-50 fst-italic">
            ƒêang c·∫≠p nh·∫≠t s·∫£n ph·∫©m g·ª£i √Ω...
        </div>

        <div class="owl-carousel owl-theme" id="nvkRandomSlider" th:if="${listRandom != null && !listRandom.isEmpty()}">
            <div class="item"
                 th:each="sp : ${listRandom.?[nvkStatus == 1 and nvkQuantity != null and nvkQuantity > 0]}">
                <div class="card h-100 shadow-sm border-0 overflow-hidden position-relative">

                    <div class="badge-discount"
                         th:if="${sp.nvkOldPrice != null && sp.nvkPrice != null && sp.nvkOldPrice > sp.nvkPrice}">
                        -[[${#numbers.formatInteger((sp.nvkOldPrice - sp.nvkPrice) / sp.nvkOldPrice * 100, 0)}]]%
                    </div>

                    <div class="card-img-container">
                        <a th:href="@{'/nvk-product/detail/' + ${sp.nvkId}}">
                            <img th:src="${(sp.nvkImgUrl != null && sp.nvkImgUrl != '')
                                    ? '/nvk-product-img/' + sp.nvkImgUrl
                                    : 'https://placehold.co/200x200?text=No+Image'}"
                                 alt="Product Image"
                                 onerror="this.src='https://placehold.co/200x200?text=Error'">
                        </a>
                    </div>

                    <div class="card-body d-flex flex-column bg-dark bg-opacity-25 pt-4">
                        <h5 class="card-title text-truncate fw-bold mb-2">
                            <a th:href="@{'/nvk-product/detail/' + ${sp.nvkId}}" class="text-decoration-none text-white"
                               th:text="${sp.nvkName}">T√™n SP</a>
                        </h5>

                        <div><span class="badge-category" th:text="${sp.nvkCategory?.nvkName ?: 'KH√ÅC'}">Category</span>
                        </div>

                        <div class="mb-3 mt-auto">
                            <span class="text-primary fw-bold fs-5">
                                <span th:if="${sp.nvkPrice != null}">[[${#numbers.formatDecimal(sp.nvkPrice, 0, 'POINT', 0, 'COMMA')}]] ‚Ç´</span>
                                <span th:unless="${sp.nvkPrice != null}">Li√™n h·ªá</span>
                            </span>
                            <span class="price-old"
                                  th:if="${sp.nvkOldPrice != null && sp.nvkPrice != null && sp.nvkOldPrice > sp.nvkPrice}">
                                [[${#numbers.formatDecimal(sp.nvkOldPrice, 0, 'POINT', 0, 'COMMA')}]] ‚Ç´
                            </span>
                        </div>
                        <a th:href="@{'/nvk-product/detail/' + ${sp.nvkId}}"
                           class="btn btn-outline-primary btn-sm rounded-pill w-100 fw-bold">Xem chi ti·∫øt</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="container my-5" th:if="${nvkProducts != null}">
        <h3 class="mb-4 text-white border-start border-4 border-info ps-3">üöÄ S·∫£n ph·∫©m s·∫Øp v·ªÅ</h3>

        <div th:if="${nvkProducts.?[nvkStatus == 2].isEmpty()}" class="text-white opacity-50 fst-italic">
            Hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m s·∫Øp v·ªÅ.
        </div>

        <div class="owl-carousel owl-theme" id="nvkComingSoonSlider"
             th:unless="${nvkProducts.?[nvkStatus == 2].isEmpty()}">

            <div class="item" th:each="p : ${nvkProducts.?[nvkStatus == 2]}">
                <div class="card h-100 shadow-sm border-0 overflow-hidden position-relative">
                    <div class="badge-coming-soon"><i class="bi bi-clock-history me-1"></i> S·∫ÆP V·ªÄ</div>

                    <div class="card-img-container">
                        <a th:href="@{'/nvk-product/detail/' + ${p.nvkId}}">
                            <img th:src="${(p.nvkImgUrl != null && p.nvkImgUrl != '')
                                    ? '/nvk-product-img/' + p.nvkImgUrl
                                    : 'https://placehold.co/200x200?text=No+Image'}"
                                 alt="Product Image" onerror="this.src='https://placehold.co/200x200?text=Error'">
                        </a>
                    </div>

                    <div class="card-body d-flex flex-column bg-dark bg-opacity-25 pt-4">
                        <h5 class="card-title text-truncate fw-bold mb-2">
                            <a th:href="@{'/nvk-product/detail/' + ${p.nvkId}}" class="text-decoration-none text-white"
                               th:text="${p.nvkName}">T√™n SP</a>
                        </h5>
                        <div><span class="badge-category" th:text="${p.nvkCategory?.nvkName ?: 'KH√ÅC'}">Category</span>
                        </div>

                        <div class="mb-3 mt-auto">
                            <span class="text-info fw-bold fs-5">
                                <span th:if="${p.nvkPrice != null && p.nvkPrice > 0}">[[${#numbers.formatDecimal(p.nvkPrice, 0, 'POINT', 0, 'COMMA')}]] ‚Ç´</span>
                                <span th:unless="${p.nvkPrice != null && p.nvkPrice > 0}">Gi√° d·ª± ki·∫øn</span>
                            </span>
                        </div>
                        <button class="btn btn-secondary btn-sm rounded-pill w-100 fw-bold opacity-75" disabled
                                style="cursor: not-allowed;">
                            <i class="bi bi-hourglass-split me-1"></i> Ch·ªù ng√†y m·ªü b√°n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-5" id="products" th:if="${nvkProducts != null}">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h3 class="fw-bold text-white m-0 border-start border-4 border-primary ps-3">S·∫£n ph·∫©m n·ªïi b·∫≠t</h3>
            <a href="/nvk-categories" class="btn btn-outline-primary btn-sm fw-bold">Xem t·∫•t c·∫£ <i
                    class="bi bi-arrow-right ms-1"></i></a>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div class="col"
                 th:each="p, loopStat : ${nvkProducts.?[nvkStatus == 1 and nvkQuantity != null and nvkQuantity > 0]}"
                 th:if="${loopStat.index < 8}">

                <div class="card h-100 shadow-sm border-0 overflow-hidden position-relative">
                    <div class="badge-discount"
                         th:if="${p.nvkOldPrice != null && p.nvkPrice != null && p.nvkOldPrice > p.nvkPrice}">
                        -[[${#numbers.formatInteger((p.nvkOldPrice - p.nvkPrice) / p.nvkOldPrice * 100, 0)}]]%
                    </div>

                    <div class="card-img-container">
                        <a th:href="@{'/nvk-product/detail/' + ${p.nvkId}}">
                            <img th:src="${(p.nvkImgUrl != null && p.nvkImgUrl != '')
                                    ? '/nvk-product-img/' + p.nvkImgUrl
                                    : 'https://placehold.co/200x200?text=No+Image'}"
                                 alt="Product Image" onerror="this.src='https://placehold.co/200x200?text=Error'">
                        </a>
                    </div>

                    <div class="card-body d-flex flex-column bg-dark bg-opacity-25 pt-4">
                        <h5 class="card-title text-truncate fw-bold mb-2">
                            <a th:href="@{'/nvk-product/detail/' + ${p.nvkId}}" class="text-decoration-none text-white"
                               th:text="${p.nvkName}">T√™n s·∫£n ph·∫©m</a>
                        </h5>
                        <div><span class="badge-category" th:text="${p.nvkCategory?.nvkName ?: 'KH√ÅC'}">Category</span>
                        </div>

                        <div class="mt-auto mb-3">
                            <span class="text-primary fw-bold fs-5">
                                <span th:if="${p.nvkPrice != null}">[[${#numbers.formatDecimal(p.nvkPrice, 0, 'POINT', 0, 'COMMA')}]] ‚Ç´</span>
                                <span th:unless="${p.nvkPrice != null}">Li√™n h·ªá</span>
                            </span>
                            <span class="price-old"
                                  th:if="${p.nvkOldPrice != null && p.nvkPrice != null && p.nvkOldPrice > p.nvkPrice}">
                                [[${#numbers.formatDecimal(p.nvkOldPrice, 0, 'POINT', 0, 'COMMA')}]] ‚Ç´
                            </span>
                        </div>

                        <button class="btn btn-primary btn-sm rounded-pill w-100 fw-bold shadow-sm"
                                th:onclick="'nvkAddToCart(' + ${p.nvkId} + ')'">
                            <i class="bi bi-cart-plus-fill me-1"></i> Th√™m v√†o gi·ªè
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 text-center text-muted py-5" th:if="${nvkProducts.empty}">
                <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</p>
            </div>
        </div>
    </div>
</main>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast align-items-center text-bg-success border-0 shadow-lg" role="alert">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toastMessage">
                <i class="bi bi-check-circle-fill me-2"></i> ƒê√£ th√™m v√†o gi·ªè!
                <a href="/nvk-cart" class="text-white text-decoration-underline ms-2 small">Xem gi·ªè h√†ng</a>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/client/footer :: footer}"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

<script>
    $(document).ready(function () {
        // SLIDER CONFIG (GI·ªÆ NGUY√äN)
        $("#nvkBannerSlider").owlCarousel({
            items: 1, loop: true, margin: 10, nav: false, dots: true,
            autoplay: true, autoplayTimeout: 5000, autoplaySpeed: 1500, smartSpeed: 1500
        });

        function initSmartSlider(selector) {
            var $slider = $(selector);
            if (!$slider.length) return;
            var itemCount = $slider.children('.item').length;
            var shouldLoop = itemCount > 4;
            $slider.owlCarousel({
                margin: 20, nav: false, dots: false, autoplay: true, autoplayTimeout: 4000,
                autoplayHoverPause: true, loop: shouldLoop, smartSpeed: 1000, autoplaySpeed: 1000,
                responsive: {
                    0: {items: 1, loop: itemCount > 1},
                    600: {items: 2, loop: itemCount > 2},
                    1000: {items: 4, loop: shouldLoop}
                }
            });
        }

        initSmartSlider("#nvkRandomSlider");
        initSmartSlider("#nvkComingSoonSlider");
    });

    // [QUAN TR·ªåNG] H√ÄM C·∫¨P NH·∫¨T S·ªê GI·ªé H√ÄNG TR√äN MENU
    function nvkAddToCart(productId) {
        fetch('/api/nvk-cart/add?productId=' + productId + '&quantity=1', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.status === 'login_required') {
                    window.location.href = '/nvk-login';
                } else if (data.status === 'success') {
                    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                    toast.show();

                    // [ƒê√É S·ª¨A] T√¨m badge gi·ªè h√†ng tr√™n Menu v√† c·∫≠p nh·∫≠t s·ªë
                    if (document.getElementById('cartBadge')) {
                        document.getElementById('cartBadge').innerText = data.cartCount;
                        document.getElementById('cartBadge').style.display = 'inline-block';
                    }
                } else if (data.status === 'error') {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</body>
</html>